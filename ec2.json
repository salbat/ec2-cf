{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "EC2 Basic Template",
    "Metadata": {},
    "Parameters": {
        "KeyName": {
            "Description": "KeyPair name that will enable SSH Access",
            "Type": "String"
        }
    },
    "Mappings": {
        "RegionMap" : {
            "us-east-1"      : { "AMI" : "ami-7f418316" },
            "us-west-1"      : { "AMI" : "ami-951945d0" },
            "us-west-2"      : { "AMI" : "ami-16fd7026" },
            "eu-west-1"      : { "AMI" : "ami-24506250" },
            "sa-east-1"      : { "AMI" : "ami-3e3be423" },
            "ap-southeast-1" : { "AMI" : "ami-74dda626" },
            "ap-southeast-2" : { "AMI" : "ami-b3990e89" },
            "ap-northeast-1" : { "AMI" : "ami-dcfa4edd" }
          }
    },
    "Conditions": {},
    "Resources": {
        "Ec2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "KeyName": { "Ref" : "KeyName" },
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "AMI"
                    ]
                },
                "SecurityGroupIds": [{"Ref": "InstanceSecurityGroup"}],
                "SubnetId" : { "Ref" : "Subnet" },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -ex\n",
                                "echo \"hello world\" > /root/hello-world.txt\n"
                            ]
                        ]
                    }
                }
            }
        },
        "myVPC" : {
            "Type" : "AWS::EC2::VPC",
            "Properties" : {
               "CidrBlock" : "10.0.0.0/16",
               "EnableDnsSupport" : "false",
               "EnableDnsHostnames" : "false",
               "InstanceTenancy" : "dedicated",
               "Tags" : [ {"Key" : "foo", "Value" : "bar"} ]
            }
         },
         "Subnet" : {
            "Type" : "AWS::EC2::Subnet",
            "Properties" : {
              "VpcId" : { "Ref" : "myVPC" },
              "CidrBlock" : "10.0.0.0/24",
              "Tags" : [ {"Key" : "Application", "Value" : { "Ref" : "AWS::StackId"} } ]
            }
        },
        "InstanceSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName" : "myVPCSecGroup",
                "GroupDescription": "Allow http and SSH to client host",
                "VpcId" : {"Ref": "myVPC"},
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "80",
                        "ToPort": "80",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "80",
                        "ToPort": "80",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "WebsiteURL": {
            "Description": "The Website URL",
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        "http://",
                        {
                            "Fn::GetAtt": [
                                "Ec2Instance",
                                "PublicDnsName"
                            ]
                        }
                    ]
                ]
            }
        }
    }
}